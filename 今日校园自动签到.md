# 今日校园自动签到

**非科班出身，代码和用语有不规范的地方请见谅**

## 一、背景

自从疫情后，我们学校每天都要今日校园签到，而我经常忘记，定了闹钟都经常忙完手上的事转眼就给忘了，是忘签到名单上的常客，准备写一个程序，让他自动签个到

## 二、准备环境

下载一个`python`环境

点击[进入官网](https://www.python.org/downloads/)

**推荐使用3.7或3.8版本**，项目使用3.7版本

## 三、简述思路

>1. **首先我们要搞明白今日校园签到你的手机会发出什么请求**
>2. **然后我们对这个请求进行一个模拟**
>3. **最后我们要想个办法让这个程序每天自动运行**

## 四、实现

### 1.对今日校园进行抓包

光是抓包就折腾了我两天，以前没爬过APP，抓到包不知从何下手😂

抓包是个重要的过程，你漏抓或者看漏了都会让你走很多弯路，我就是

### 2.写代码

创建一个`config/config.json`文件用于存放配置数据

#### 1.配置日志文件

新建文件`logger.conf`

```
#logger.conf

###############################################

[loggers]
keys=root,jrxy

[logger_root]
level=DEBUG
handlers=stream

[logger_jrxy]
handlers=stream,timedrt,http
qualname=jrxy
propagate=0

###############################################

[handlers]
keys=stream,timedrt,http

[handler_stream]
class=StreamHandler
level=NOTSET
formatter=form01
args=(sys.stderr,)

[handler_filert]
class=handlers.RotatingFileHandler
level=INFO
formatter=form02
args=('log/jrxy.log', 'a', 10*1024*1024, 5)

[handler_timedrt]
class=handlers.TimedRotatingFileHandler
level=DEBUG
formatter=form01
args=('log/jrxy.log', 'd', 1 , 5 )

[handler_http]
class=handlers.HTTPHandler
level=ERROR
formatter=form01
args=('localhost:8087', '/api/v1.0/log', 'POST')


###############################################

[formatters]
keys=form01,form02

[formatter_form01]
format=[%(asctime)s][%(filename)s][line:%(lineno)d][%(levelname)s] %(message)s
datefmt=%a, %d %b %Y %H:%M:%S

[formatter_form02]
format=%(name)-12s: %(levelname)-8s %(message)s
datefmt=
```

新建`config.py`

```python
import logging
from logging import config

logging.config.fileConfig("logger.conf")
logger = logging.getLogger("jrxy")
```

新建文件夹`log`,在log文件夹中新建文件`jrxy.log`

#### 2.获取学校ID

新建`getSchoolId.py`文件

```python
def getJson(url):
    try:
        r = requests.get(url, timeout=5)
        r.encoding = r.apparent_encoding
        return r.json()['data']
    except:
        raise

def cleanData(data: dict, school_list: list):
    pass
```

**这里有接口限制，不要频繁调用接口**

***这里不贴出具体实现，拿到数据了，从数据中找到学校ID应该不难。***

#### 3.获取登录的地址

~~登录地址不好搞啊，目前仅支持`大连大学`, 会搞的可以自己改改~~

新建`getSchoolLoginUrl.py`文件

```python
def getlogin(__school_id):
    pass
```

~~**第二步可以省略，我当时是写都写了就直接用id了，会改的微改一下第三步的代码即可**~~

**不可以省略，自行获取必须要学校ID**

#### 4模拟登录

新建`login.py`文件

~~登录非常麻烦，有非常多的验证，验证虽然多，但还好的是过了验证就成功一半了😁~~

主要前面配置请求头一定要配置正确

***==加油上学人！！！==***

```python
class Login:
    def __init__(self, data):
        pass

    # 解密 不会做逆向，解密和初始是直接复制FuckCampus项目的
    def encrypt(self, text):
        pass

    # 重写requests方法 重构的requests方法，我感觉这一步简直就是神来之笔
    def request(self, url: str, data=None, parseJson=True, JsonBody=True, Referer=None):
        try:
            url = url.format(host=self.host)
            if Referer != None:
                self.session.headers.update({"Referer": Referer})
            if data == None:
                res = self.session.get(url)
            else:
                self.session.headers.update(
                    {"Content-Type": ("application/json" if JsonBody else "application/x-www-form-urlencoded")})
                res = self.session.post(url, data=(
                    json.dumps(data) if JsonBody else data))
            if parseJson:
                return json.loads(res.text)
            else:
                return res
        except:
            # TODO send_email
            logger.debug('登录: 获取链接失败')
            exit(-1)

    # 登录
    def login(self, captcha=""):
        pass
```

我构造了一个类来实现登录

#### 5.获取表单

在`Login`类中

```python
    def getcollectorlist(self):
        pass
    # 获取schoolTaskWid
    def getdetailcollector(self, data):
        pass

    # 查询form
    def queryform(self, data):
        pass
```



#### 6.填写并提交表单

现在我们来填写表单

```python
	def fillform(self, form):
		pass
    
    # 我没有遇见过问题类型为3，4的，上面关于问题类型为3，4的和下面的验证我都是直接复制auto-submit那个项目的
    def uploadpicture(self, image):
        pass
    
    def getpictureurl(self, fileName):
        pass
```

提交表单，***这里就不贴出具体参数了***

```python
	def submitform(self):
        pass
```

#### 7.做一个生成配置文件的程序

新建一个`generate.py`文件，这个是受到了auto-submit的启发，如果不懂代码确实容易配置错，既然这样那我就写个配置程序帮你配置

这个程序作用不大，会自己配置的可以自己配置，我就写得很潦草很不规范，抱歉😜

并且我只遇见过问题类型1和2，对3，4的支持可能没那么好，能自行配置的可以自行配置

```python
import json
import os
if not os.path.exists(os.getcwd()+'\\config'):
    os.mkdir(os.getcwd()+'\\config')
if not os.path.exists(os.getcwd()+'\\log'):
    os.mkdir(os.getcwd()+'\\log')
if not os.path.isfile(os.getcwd()+'\\log\\jrxy.log'):
    with open(os.getcwd()+'\\log\\jrxy.log', 'w', encoding='utf-8') as f:
        f.write('# @author   : GaiusPluto')


if __name__ == '__main__':
    fs = input('请输入你大学的首字母: ').upper()
    print(fs)
    school_name = input('请输入你大学名字: ')
    print(school_name)
    username = input('请输入你的学号(仅支持学号): ')
    password = input('请输入你的密码: ')
    address = input('请输入你的地址: ')
    form_list = []
    flag = 1
    while True:
        title = input("输入问题"+str(flag)+"标题(建议直接复制粘贴,输入-1结束): ")
        if title == '-1':
            break
        type = input('输入问题'+str(flag)+'类型,一般回答问题为1,单选为2,多选为3,拍摄照片为4: ')
        value = input('输入问题'+str(flag)+'的默认回答: ')
        form_list.append({
          "default": {
            "title": title,
            "type": eval(type),
            "value": value
          }
        })
        flag+=1
    config = {
        "data": {
            "getSchoolId": {
                "url": "https://static.campushoy.com/apicache/tenantListSort",
                "sectionName": "{}".format(fs),
                "name": "{}".format(school_name)
            },
            "getSchoolLoginUrl": {
                "url": "https://mobile.campushoy.com/v6/config/guest/tenant/list"
            },
            "login": {
                "username": "{}".format(username),
                "password": "{}".format(password),
                "address": "{}".format(address)
            },
            "rem_form": False,
            "form": {
                "defaults": form_list
            }
        }
    }
    json.dump(config, open(os.getcwd()+'\\conf\\config.json', 'w', encoding='utf-8'))
```



### 3.通知使用者结果

我的想法是做一个接口，微信通知，因为每天一封邮件还要专门打开邮件来看真的很麻烦，这个暂时还没实现，等我做完这个我再去捣鼓微信公众号咋弄吧😂

### 4.使用

关于这个问题其实网上有很好的办法了，就是**腾讯云函数**

其实我还有个想法就是部署在本地，电脑一开机你自动签到打卡，这东西也挺简单

### 5.结果

![](./Images/result.png)

## 吐吐槽

**连着好几天都在搞这个今日校园自动签到，真的就是感觉你在金智的程序猿相互较量，也不是没有收获，代码删删改改，文件建立又删除，有时候你抓包找到一个链接，你看别人的代码又有更好的接口和方法，特别是他的加密我又不会逆向，如果没有其他大佬的帮助，我恐怕卡多久都想不出哪个小地方做了加密，做了验证，金智对接口好像有限制，没有必要不要频繁调用接口😂**

## 参考资料

[auto-submit](https://github.com/ZimoLoveShuang/auto-submit.git)这位大佬很久没有更新了，一些接口已经失效，但是他的对表单的处理方式我表示学到了

[FuckCampus](https://github.com/Plutoeat/FuckCampus.git)这个资料带个我非常多的提示，重写requests方法我是真没想到，还有他的解密函数，**感谢**

**感谢两位大佬！！！**
